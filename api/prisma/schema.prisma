// Prisma schema for AlternaGen V1
// Database: PostgreSQL 15

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MANAGEMENT
// ============================================

model User {
  id        String   @id @default(uuid())
  clerkId   String   @unique @map("clerk_id")
  email     String   @unique
  firstName String?  @map("first_name")
  lastName  String?  @map("last_name")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  profile      Profile?
  jobs         Job[]
  applications Application[]
  matchScores  MatchScore[]

  @@map("users")
}

model Profile {
  id                 String   @id @default(uuid())
  userId             String   @unique @map("user_id")
  educationLevel     String?  @map("education_level") // "Bac+3", "Bac+5", etc.
  fieldOfStudy       String?  @map("field_of_study") // "Marketing", "Computer Science"
  skills             String[] // Array of skills
  preferredLocations String[] @map("preferred_locations") // ["Paris", "Lyon"]
  preferredSectors   String[] @map("preferred_sectors") // ["Tech", "Finance"]
  cvUrl              String?  @map("cv_url")
  bio                String?  @db.Text
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("profiles")
}

// ============================================
// JOB MANAGEMENT
// ============================================

model Job {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  title        String
  company      String
  location     String?
  description  String?  @db.Text
  requirements String?  @db.Text
  url          String   @unique
  source       String? // "LinkedIn", "Indeed", "Manual", etc.
  savedAt      DateTime @default(now()) @map("saved_at")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  applications Application[]
  matchScores  MatchScore[]

  @@index([userId])
  @@index([savedAt(sort: Desc)])
  @@map("jobs")
}

// ============================================
// APPLICATION TRACKING
// ============================================

enum ApplicationStatus {
  SAVED
  APPLIED
  INTERVIEW
  OFFER
  REJECTED

  @@map("application_status")
}

model Application {
  id        String            @id @default(uuid())
  userId    String            @map("user_id")
  jobId     String            @map("job_id")
  status    ApplicationStatus @default(SAVED)
  notes     String?           @db.Text
  appliedAt DateTime?         @map("applied_at")
  createdAt DateTime          @default(now()) @map("created_at")
  updatedAt DateTime          @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  job  Job  @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@unique([userId, jobId])
  @@index([userId, status])
  @@map("applications")
}

// ============================================
// MATCHING SYSTEM
// ============================================

model MatchScore {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  jobId        String   @map("job_id")
  score        Int // 0-100
  explanation  String?  @db.Text
  calculatedAt DateTime @default(now()) @map("calculated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  job  Job  @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@unique([userId, jobId])
  @@index([userId, score(sort: Desc)])
  @@map("match_scores")
}
