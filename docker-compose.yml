version: '3.8'

services:
  # Postgres Primary
  db-primary:
    image: bitnami/postgresql:latest
    container_name: altergen-db-primary
    environment:
      POSTGRESQL_USERNAME: ${POSTGRES_USER:-postgres}
      POSTGRESQL_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRESQL_DATABASE: ${POSTGRES_DB:-altergen}
      POSTGRESQL_REPLICATION_MODE: master
      POSTGRESQL_REPLICATION_USER: repl_user
      POSTGRESQL_REPLICATION_PASSWORD: repl_password
    ports:
      - "5432:5432"
    volumes:
      - postgres_primary_data:/bitnami/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Postgres Replica 1
  db-replica-1:
    image: bitnami/postgresql:latest
    container_name: altergen-db-replica-1
    depends_on:
      db-primary:
        condition: service_healthy
    environment:
      POSTGRESQL_USERNAME: ${POSTGRES_USER:-postgres}
      POSTGRESQL_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRESQL_DATABASE: ${POSTGRES_DB:-altergen}
      POSTGRESQL_MASTER_HOST: db-primary
      POSTGRESQL_MASTER_PORT_NUMBER: 5432
      POSTGRESQL_REPLICATION_MODE: slave
      POSTGRESQL_REPLICATION_USER: repl_user
      POSTGRESQL_REPLICATION_PASSWORD: repl_password
    volumes:
      - postgres_replica_1_data:/bitnami/postgresql

  # Postgres Replica 2
  db-replica-2:
    image: bitnami/postgresql:latest
    container_name: altergen-db-replica-2
    depends_on:
      db-primary:
        condition: service_healthy
    environment:
      POSTGRESQL_USERNAME: ${POSTGRES_USER:-postgres}
      POSTGRESQL_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRESQL_DATABASE: ${POSTGRES_DB:-altergen}
      POSTGRESQL_MASTER_HOST: db-primary
      POSTGRESQL_MASTER_PORT_NUMBER: 5432
      POSTGRESQL_REPLICATION_MODE: slave
      POSTGRESQL_REPLICATION_USER: repl_user
      POSTGRESQL_REPLICATION_PASSWORD: repl_password
    volumes:
      - postgres_replica_2_data:/bitnami/postgresql

  # Backend API
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: altergen-api
    environment:
      PORT: 3001
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@db-primary:5432/${POSTGRES_DB:-altergen}
      NODE_ENV: ${NODE_ENV:-development}
      JWT_SECRET: ${JWT_SECRET}
    ports:
      - "3001:3001"
    volumes:
      - ./api:/app
      - /app/node_modules
    depends_on:
      db-primary:
        condition: service_healthy
    command: npm run dev

  # Frontend Web App
  web:
    build:
      context: ./web/my-clek-app
      dockerfile: Dockerfile
      target: development
    container_name: altergen-web
    environment:
      VITE_API_URL: http://localhost:3001
    ports:
      - "3000:3000"
    volumes:
      - ./web/my-clek-app:/app
      - /app/node_modules
    depends_on:
      - api
    command: npm run dev

  # Monitoring
  prometheus:
    image: prom/prometheus:latest
    container_name: altergen-prometheus
    volumes:
      - ./infra/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    ports:
      - "9090:9090"
    restart: unless-stopped

volumes:
  postgres_primary_data:
    driver: local
  postgres_replica_1_data:
    driver: local
  postgres_replica_2_data:
    driver: local
  prometheus_data:
    driver: local
